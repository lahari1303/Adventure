<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>A Little Adventure for Gayu ‚ú®</title>
    <style>
      :root {
        --bg: #de25b6;
        --card: #6c53f5;
        --ink: #ffffff;
        --muted: #000000;
        --accent: #7a8ee8;
        --gold: #ffd166;
        --ok: #1dffbb;
        --bad: #ff7b7b;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
        color: var(--ink);
        background: radial-gradient(
            1200px 700px at 20% 10%,
            #182668 0%,
            transparent 60%
          ),
          radial-gradient(900px 600px at 80% 20%, #0f1535 0%, transparent 60%),
          radial-gradient(1000px 800px at 50% 100%, #101735 0%, transparent 60%),
          var(--bg);
        min-height: 100dvh;
        display: grid;
        place-items: center;
        padding: 20px;
      }

      .container {
        width: min(920px, 100%);
        background: var(--card);
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
        overflow: hidden;
      }

      header {
        position: sticky;
        /* position: fixed; */
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        padding: 16px 18px;
        background: #0f1530;
      }
      /* header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000; 
      } */

      .title {
        font-weight: 800;
      }
      .pill {
        color: var(--ink);
        border: 1px solid rgba(255, 255, 255, 0.15);
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 13px;
      }

      .progress {
        height: 10px;
        background: rgba(255, 255, 255, 0.12);
        margin: 20px 18px 0; /* top 20px, sides 18px, bottom 0 */
        border-radius: 999px;
        overflow: hidden;
      }
      .progress > i {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--accent), var(--gold));
        transition: width 0.35s ease;
      }

      main {
        padding: 20px 18px;
        min-height: 320px;
      }
      h2 {
        margin: 0 0 6px;
      }
      p {
        margin: 0 0 12px;
      }
      .desc {
        color: var(--muted);
      }
      /* .story-container {
        display: flex;
        align-items: flex-start;
        gap: 20px;
        margin-top: 10px;
      }

      .story-container .desc {
        flex: 2;
        line-height: 1.6;
        font-style: italic;
        color: var(--ink);
      }

      .story-container .images img {
        max-width: 250px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      } */

      .images {
        margin: 12px 0;
        text-align: center;
      }

      .images img {
        max-width: 90%; /* prevents huge JPGs from filling screen */
        max-height: 300px; /* keeps them controlled in height */
        height: auto;
        display: block;
        margin: 10px auto;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        object-fit: contain; /* keeps full picture visible */
      }
      /* #content {
        padding-top: 20px;
      } */

      /* .images {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin: 12px 0;
        align-items: center;
      } */
      /* .images {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 10px;
        margin: 12px 0;
      } */
      /*.images img {*/
      /* width: 100%;
        border-radius: 12px;
        display: block;
        object-fit: cover;
        height: 150px; */
      /* max-width: 100%;
        height: auto;
        display: block;
        margin: 0 auto;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }*/

      .poem-page {
        text-align: center;
        padding: 40px 20px;
      }

      .poem-text {
        white-space: pre-wrap;
        font-size: 16px;
        font-style: italic;
        line-height: 1.6;
        color: var(--gold);
      }

      .input-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        margin-top: 8px;
      }
      input[type="text"],
      input[type="number"] {
        flex: 1 1 240px;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: #0f1530;
        color: var(--ink);
        outline: none;
      }
      input[type="text"]:focus {
        box-shadow: 0 0 0 3px rgba(122, 142, 232, 0.12);
      }
      .btn {
        cursor: pointer;
        padding: 12px 16px;
        border-radius: 12px;
        border: none;
        font-weight: 700;
      }
      .primary {
        background: linear-gradient(90deg, var(--accent), var(--gold));
        color: #0b0f1d;
      }
      .ghost {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: var(--ink);
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .feedback {
        min-height: 22px;
        font-size: 14px;
        margin-top: 8px;
      }
      .ok {
        color: var(--ok);
      }
      .bad {
        color: var(--bad);
      }

      /* jigsaw */
      #jigsaw {
        display: grid;
        justify-content: center;
        margin: 14px 0;
        gap: 6px;
      }
      #jigsaw .tile {
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        width: 100px;
        height: 100px;
        background-size: cover;
        background-repeat: no-repeat;
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
        outline: none;
      }
      #jigsaw .selected {
        outline: 3px solid rgba(255, 255, 255, 0.14);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
      }

      footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        padding: 14px 18px 18px;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
      }
      .note {
        color: var(--muted);
        font-size: 12px;
      }
      .links {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
        margin-top: 12px;
      }
      .linkcard {
        display: block;
        padding: 14px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: #0f1530;
        color: var(--ink);
        text-decoration: none;
      }
      .linkcard small {
        color: var(--muted);
        display: block;
        margin-top: 4px;
      }

      /* small screens */
      @media (max-width: 560px) {
        .images img {
          height: 120px;
        }
        main {
          padding: 16px;
        }
        header {
          padding: 12px;
        }
      }

      /* confetti canvas sits on top */
      .confetti-canvas {
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        pointer-events: none;
        z-index: 9999;
      }
      #welcome-screen {
        position: fixed;
        inset: 0;
        background: #ffccd5;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 1s ease;
      }

      .heart {
        position: relative;
        width: 150px;
        height: 150px;
        background: red;
        transform: rotate(-45deg);
        cursor: pointer;
      }

      .heart::before,
      .heart::after {
        content: "";
        position: absolute;
        width: 150px;
        height: 150px;
        background: red;
        border-radius: 50%;
        transition: transform 1s ease;
      }
      .heart::before {
        top: -75px;
        left: 0;
      }
      .heart::after {
        left: 75px;
        top: 0;
      }

      .heart.open::before {
        transform: translateX(-200px) rotate(-30deg);
      }
      .heart.open::after {
        transform: translateX(200px) rotate(30deg);
      }
    </style>
  </head>
  <body>
    <div id="welcome-screen">
      <div class="heart" id="heart-door"></div>
    </div>
    <div class="container" role="application" aria-labelledby="huntTitle">
      <header>
        <div class="title" id="huntTitle">‚ú® A Little Adventure</div>
        <span class="pill">For: <b id="herName">Her</b></span>
      </header>

      <div class="progress" aria-label="Progress">
        <i id="bar" style="width: 0%"></i>
      </div>

      <main id="content" tabindex="0"><!-- dynamic content --></main>

      <footer>
        <div>
          <div class="note">Love You ‚ù§Ô∏è</div>
          <div style="margin-top: 8px">
            <button class="btn ghost" id="resetBtn" title="Reset progress">
              Reset üîÅ
            </button>
          </div>
        </div>

        <div>
          <button class="btn ghost" id="prevBtn" aria-label="Back">
            ‚óÄ Back
          </button>
          <button class="btn primary" id="nextBtn" aria-label="Next" disabled>
            Next ‚ñ∂
          </button>
        </div>
      </footer>
    </div>

    <script>
      /* ========== CONFIG ========== */
      const config = {
        herName: "Narreddy Gayathri",
        starCertificate: "https://www.instagram.com/p/DLNJkbjSFz0/",
        video: "", // optional YouTube embed url
      };
      const heart = document.getElementById("heart-door");
      const welcome = document.getElementById("welcome-screen");

      heart.addEventListener("click", () => {
        heart.classList.add("open");
        setTimeout(() => {
          welcome.style.opacity = "0";
          setTimeout(() => (welcome.style.display = "none"), 1000);
        }, 1000);
      });

      /* ========== PUZZLES ========== */
      const puzzles = [
        {
          type: "story",
          text: `Hey Riiiii,<br><br>
           You are twenty-one,<br>
the age where stories unfold,<br>
but you will always be my one‚Äî<br>
more precious than silver or gold.<br><br>

No matter the years,<br>
or places we run,<br>
in my heart, you stay near,<br>
forever my one, forever my dear.<br>

`,
        },

        {
          type: "text",
          question: "The brother and sister Duo who is as thin as you are?",
          answer: "Harini and Harish",
        },

        {
          type: "story",
          text: `In Our Seat on the School Bus<br><br>
      Dreams we have dreamt
      in our designated bus seat,<br>
      bouncing along to the rhythm
      of wheels on morning streets.<br><br>
      Homeworks done at the last minute,
      notebooks tossed, pens running dry,<br>
      whispers mixed with the hum of tires,
      a race against the school-day sky.<br><br>
      Countless tales we've shared,
      spinning magic between bus stops,<br>
      stories that curl like laughter
      inside our little corner of the world.<br><br>
      There, in that seat,
      our world wobbled but never broke‚Äî<br>
      where friendship grew wild and free,
      and every journey felt like home.`,
          image: "memory1.jpg",
        },

        {
          type: "text",
          question: "What did we eat after celebrating your birthday?",
          answer: "chicken gravy",
        },
        // step-by-step memory parts (we'll treat these as separate story slides)
        {
          type: "story",
          text: "Probably our FIRST Picture Together (Even though there is another person in it and you look like you were kidnapped in the picture)",
          image: "memory2a.jpg",
        },
        {
          type: "story",
          text: "When you visited my HOME for the First time",
          image: "memory2b.jpg",
        },
        {
          type: "story",
          text: "Our Late Night calls üåô",
          image: "memory2c.jpg",
        },

        {
          type: "text",
          question:
            "What is the thing in your pocket when we FOUGHT for the first time?",
          answer: "Melted Dairy Milk",
        },

        {
          type: "jigsaw",
          question: "Rearrange the pieces to reveal a memory üß©",
          image: "puzzle.jpg",
          rows: 4,
          cols: 5,
        },

        {
          type: "text",
          question:
            "What was the date when we had our first sleepover at your home?",
          answer: "9th JUNE",
        },

        {
          type: "poem",
          text: `üå∏ A Decade Together üå∏

Almost ten years‚Äî
from silly dreams beneath classroom skies,
to ambitious plans of jobs and futures,
from sitting side by side in school halls,
to colleges miles apart‚Äîfour hundred seventeen away.

We shared lunch boxes once, hand to hand,
now unaware even of each other‚Äôs daily meals,
from playground laughter and endless games,
to scarce moments stolen from busy lives.

From daily chatter that filled the air,
to weekly calls that bridge the distance,
from seeing each other every day,
to treasured meetings, once a year.

Characters changed, lives rearranged,
surroundings shifted like seasons,
but through it all,
our friendship has stood like a steadfast tree‚Äî
rooted deep, growing strong,
a bond unbroken, forever long..`,
          next: "final",
        },

        { type: "final" },
      ];

      /* ========== HELPERS ========== */
      const $ = (id) => document.getElementById(id);
      const norm = (s) => (s + "").toLowerCase().trim().replace(/\s+/g, " ");

      // small wrong-sound (WebAudio) ‚Äî no external file
      function playWrongSound() {
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = "sawtooth";
          o.frequency.value = 220;
          g.gain.value = 0.15;
          o.connect(g);
          g.connect(ctx.destination);
          o.start();
          // descending pitch quickly
          const now = ctx.currentTime;
          o.frequency.setValueAtTime(220, now);
          o.frequency.exponentialRampToValueAtTime(120, now + 0.18);
          g.gain.exponentialRampToValueAtTime(0.0001, now + 0.18);
          setTimeout(() => {
            o.stop();
            ctx.close();
          }, 220);
        } catch (e) {
          console.warn("Audio error", e);
        }
      }

      // pleasant success chime
      function playSuccessSound() {
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const o1 = ctx.createOscillator();
          const o2 = ctx.createOscillator();
          const g = ctx.createGain();
          o1.type = "sine";
          o2.type = "sine";
          o1.frequency.value = 660;
          o2.frequency.value = 880;
          g.gain.value = 0.08;
          o1.connect(g);
          o2.connect(g);
          g.connect(ctx.destination);
          o1.start();
          o2.start();
          const now = ctx.currentTime;
          o1.frequency.setValueAtTime(660, now);
          o1.frequency.exponentialRampToValueAtTime(420, now + 0.35);
          o2.frequency.setValueAtTime(880, now);
          o2.frequency.exponentialRampToValueAtTime(660, now + 0.35);
          g.gain.exponentialRampToValueAtTime(0.0001, now + 0.45);
          setTimeout(() => {
            o1.stop();
            o2.stop();
            ctx.close();
          }, 520);
        } catch (e) {
          console.warn("Audio error", e);
        }
      }

      /* ========== CONFETTI ========== */
      function launchConfetti() {
        const canvas = document.createElement("canvas");
        canvas.className = "confetti-canvas";
        document.body.appendChild(canvas);
        const ctx = canvas.getContext("2d");
        const DPR = window.devicePixelRatio || 1;
        function resize() {
          canvas.width = innerWidth * DPR;
          canvas.height = innerHeight * DPR;
          canvas.style.width = innerWidth + "px";
          canvas.style.height = innerHeight + "px";
          ctx.scale(DPR, DPR);
        }
        resize();
        window.addEventListener("resize", resize);

        const pieces = [];
        const colors = ["#ffd166", "#7a8ee8", "#1dffbb", "#ff7b7b", "#ffffff"];
        for (let i = 0; i < 120; i++) {
          pieces.push({
            x: Math.random() * innerWidth,
            y: Math.random() * -innerHeight,
            w: 6 + Math.random() * 10,
            h: 8 + Math.random() * 12,
            color: colors[Math.floor(Math.random() * colors.length)],
            rot: Math.random() * Math.PI * 2,
            velY: 2 + Math.random() * 6,
            velX: -3 + Math.random() * 6,
            spin: -0.1 + Math.random() * 0.2,
          });
        }

        let running = true;
        const start = performance.now();
        function frame(t) {
          if (!running) return;
          const elapsed = t - start;
          ctx.clearRect(0, 0, innerWidth, innerHeight);
          for (const p of pieces) {
            p.x += p.velX;
            p.y += p.velY;
            p.rot += p.spin;
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rot);
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
            ctx.restore();
          }
          // stop after 3.5s
          if (elapsed < 3500) requestAnimationFrame(frame);
          else {
            running = false;
            window.removeEventListener("resize", resize);
            canvas.remove();
          }
        }
        requestAnimationFrame(frame);
      }

      /* ========== STATE ========== */
      let idx = Math.max(
        0,
        parseInt(localStorage.getItem("hunt_idx") || "0", 10)
      );
      let unlockNext = false; // used for enabling next button when needed

      function setProgress() {
        const pct = Math.round((idx / (puzzles.length - 1)) * 100);
        $("bar").style.width = pct + "%";
        localStorage.setItem("hunt_idx", String(idx));
      }

      /* ========== RENDER ========== */
      function render() {
        const p = puzzles[idx];
        $("herName").textContent = config.herName;
        setProgress();
        // story and final allow manual next only when story; final should not show next
        unlockNext = p.type === "story";
        $("nextBtn").disabled = !unlockNext || p.type === "final";

        $("content").innerHTML = "";

        // story slide
        // if (p.type === "story") {
        //   $("content").innerHTML = `
        //               <h2>Memory Stop</h2>
        //               <p class="desc">${p.text}</p>
        //               ${
        //                 p.image
        //                   ? `<div class="images"><img src="${p.image}" alt="memory" onerror="this.style.opacity=.4; this.alt='missing'"></div>`
        //                   : ""
        //               }
        //             `;
        // }
        if (p.type === "story") {
          $("content").innerHTML = `
    <h2>Memory Stop</h2>
    <div class="story-container">
      <p class="desc">${p.text}</p>
      ${
        p.image
          ? `<div class="images"><img src="${p.image}" alt="memory" onerror="this.style.opacity=.4; this.alt='missing'"></div>`
          : ""
      }
    </div>
  `;
        }

        // text puzzle (auto-advance on correct; wrong sound on wrong)
        if (p.type === "text") {
          $("content").innerHTML = `
                      <h2>Memory Riddle</h2>
                      <p class="desc">${p.question}</p>
                      <div class="input-row">
                        <input id="ans" type="text" placeholder="Your answer" autocomplete="off" aria-label="Answer"/>
                        <button class="btn primary" id="checkBtn">Check</button>
                      </div>
                      <div id="fb" class="feedback" role="status" aria-live="polite"></div>
                    `;
          const ansEl = $("ans");
          const fb = $("fb");
          ansEl.focus();

          function checkText() {
            const user = norm(ansEl.value);
            const correct = norm(p.answer);
            if (user === correct) {
              fb.textContent = "Correct! üéâ";
              fb.className = "feedback ok";
              playSuccessSound();
              // auto-advance quickly
              setTimeout(() => {
                nextStep();
              }, 450);
            } else {
              fb.textContent = "Not quite ‚Äî try again.";
              fb.className = "feedback bad";
              playWrongSound();
            }
          }

          $("checkBtn").onclick = checkText;
          ansEl.addEventListener("keydown", (e) => {
            if (e.key === "Enter") checkText();
          });
        }

        // photo puzzle (same behavior as text)
        if (p.type === "photo") {
          $("content").innerHTML = `
                      <h2>Photo Riddle</h2>
                      <p class="desc">${p.question}</p>
                      ${imagesHtml(p)}
                      <div class="input-row">
                        <input id="ans" type="text" placeholder="Your answer" autocomplete="off" aria-label="Answer"/>
                        <button class="btn primary" id="checkBtn">Check</button>
                      </div>
                      <div id="fb" class="feedback" role="status" aria-live="polite"></div>
                    `;
          const ansEl = $("ans");
          const fb = $("fb");
          ansEl.focus();

          function checkPhoto() {
            const user = norm(ansEl.value);
            const correct = norm(p.answer);
            if (user === correct) {
              fb.textContent = "You got it! ‚ú®";
              fb.className = "feedback ok";
              playSuccessSound();
              setTimeout(() => {
                nextStep();
              }, 450);
            } else {
              fb.textContent = "Hint: think of that trip‚Ä¶";
              fb.className = "feedback bad";
              playWrongSound();
            }
          }

          $("checkBtn").onclick = checkPhoto;
          ansEl.addEventListener("keydown", (e) => {
            if (e.key === "Enter") checkPhoto();
          });
        }

        // jigsaw puzzle
        if (p.type === "jigsaw") {
          const rows = p.rows || 3,
            cols = p.cols || 3;
          // tile size responsive: try to fit within 85% of container width
          const containerWidth = Math.min(920, window.innerWidth - 80);
          const tile = Math.max(56, Math.floor((containerWidth * 0.85) / cols));
          $("content").innerHTML = `
                      <h2>Jigsaw Memory</h2>
                      <p class="desc">${p.question}</p>
                      <div id="jigsaw" style="grid-template-columns:repeat(${cols}, ${tile}px)"></div>
                      <div id="fb" class="feedback" role="status" aria-live="polite"></div>
                    `;
          buildJigsaw($("jigsaw"), p.image, rows, cols, tile);
        }
        if (p.type === "poem") {
          $("content").innerHTML = `
    <h2>Special Poem</h2>
    <div class="poem-page fade-in">
      <pre class="poem-text">${p.text}</pre>
    </div>
  `;

          // ‚úÖ Enable Next button manually
          $("nextBtn").disabled = false;
          $("nextBtn").onclick = () => nextStep();
        }

        // final slide
        if (p.type === "final") {
          $("content").innerHTML = `
                      <h2>The Treasure üéÅ</h2>
                      <p class="desc">You did it! Here‚Äôs your gift ‚Äî it‚Äôs yours forever.</p>
                      <div class="links">
                        <a class="linkcard" href="${
                          config.starCertificate
                        }" target="_blank" rel="noopener noreferrer">
                          <b>Open Your Gift</b>
                          <small>PDF / Star Map</small>
                        </a>
                        ${
                          config.video
                            ? `<a class="linkcard" href="${config.video}" target="_blank" rel="noopener noreferrer"><b>Play a Little Message</b><small>YouTube (unlisted)</small></a>`
                            : ""
                        }
                      </div>
                      <div class="feedback ok" style="margin-top:10px">Tip: Make sure Your Sound is ON üíõ</div>
                    `;
          // celebration
          playSuccessSound();
          launchConfetti();
        }

        // prev btn state
        $("prevBtn").disabled = idx === 0;
      }

      function imagesHtml(p) {
        if (Array.isArray(p.images)) {
          return `<div class="images">${p.images
            .map(
              (u) =>
                `<img src="${u}" alt="photo" onerror="this.style.opacity=.4; this.alt='missing'">`
            )
            .join("")}</div>`;
        } else if (p.image) {
          return `<div class="images"><img src="${p.image}" alt="photo" onerror="this.style.opacity=.4; this.alt='missing'"></div>`;
        }
        return "";
      }

      /* ========== JIGSAW (click-select + drag-swap) ========== */
      function buildJigsaw(container, img, rows, cols, size) {
        container.style.gap = "6px";
        container.style.gridTemplateRows = `repeat(${rows}, ${size}px)`;
        container.innerHTML = "";
        const pieces = [];
        // create ordered pieces (correct positions)
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            const d = document.createElement("div");
            d.className = "tile";
            d.draggable = !("ontouchstart" in window); // disable native drag for touch devices
            d.style.width = size + "px";
            d.style.height = size + "px";
            d.style.backgroundImage = `url(${img})`;
            d.style.backgroundSize = `${cols * size}px ${rows * size}px`;
            d.style.backgroundPosition = `-${c * size}px -${r * size}px`;
            d.dataset.correct = `${r}-${c}`; // identity of this piece
            d.setAttribute("role", "button");
            d.setAttribute("tabindex", "0");
            pieces.push(d);
          }
        }
        // shuffle pieces and append
        const shuffled = pieces.slice().sort(() => Math.random() - 0.5);
        shuffled.forEach((tile) => container.appendChild(tile));

        // interactions: drag & drop swap + click-to-select swap
        let dragSrc = null;
        let selected = null;

        // attach handlers (after appended so nodes are actual children)
        function refreshHandlers() {
          container.querySelectorAll(".tile").forEach((tile) => {
            // remove old listeners by cloning node (safe approach) ‚Äî but keep dataset
            if (!tile._handlersAttached) {
              tile.addEventListener("dragstart", (e) => {
                dragSrc = tile;
                tile.classList.add("selected");
              });
              tile.addEventListener("dragend", () => {
                if (dragSrc) dragSrc.classList.remove("selected");
                dragSrc = null;
              });
              tile.addEventListener("dragover", (e) => e.preventDefault());

              tile.addEventListener("drop", (e) => {
                e.preventDefault();
                if (!dragSrc || dragSrc === tile) return;
                swapNodes(container, dragSrc, tile);
                if (dragSrc) dragSrc.classList.remove("selected");
                dragSrc = null;
                // check solved
                if (isSolved(container, rows, cols)) {
                  $("fb").textContent = "Perfect! Puzzle solved ‚úÖ";
                  $("fb").className = "feedback ok";
                  playSuccessSound();
                  setTimeout(() => nextStep(), 700);
                }
              });

              // click-to-select swap (touch-friendly)
              tile.addEventListener("click", () => {
                if (!selected) {
                  selected = tile;
                  tile.classList.add("selected");
                  tile.focus();
                } else if (selected === tile) {
                  selected.classList.remove("selected");
                  selected = null;
                } else {
                  const a = selected,
                    b = tile;
                  swapNodes(container, a, b);
                  a.classList.remove("selected");
                  selected = null;
                  if (isSolved(container, rows, cols)) {
                    $("fb").textContent = "Perfect! Puzzle solved ‚úÖ";
                    $("fb").className = "feedback ok";
                    playSuccessSound();
                    setTimeout(() => nextStep(), 700);
                  }
                }
              });

              // keyboard support (Enter/Space acts like click)
              tile.addEventListener("keydown", (e) => {
                if (e.key === "Enter" || e.key === " ") {
                  e.preventDefault();
                  tile.click();
                }
              });

              tile._handlersAttached = true;
            }
          });
        }

        refreshHandlers();
      }

      // swap two nodes in the DOM while preserving event listeners (simple insertBefore trick)
      function swapNodes(container, a, b) {
        if (a === b) return;
        const aNext = a.nextSibling === b ? a : a.nextSibling;
        container.insertBefore(a, b);
        container.insertBefore(b, aNext);
      }

      function isSolved(container, rows, cols) {
        const tiles = [...container.children];
        if (tiles.length !== rows * cols) return false;
        for (let i = 0; i < tiles.length; i++) {
          const row = Math.floor(i / cols),
            col = i % cols;
          if (tiles[i].dataset.correct !== `${row}-${col}`) return false;
        }
        return true;
      }

      /* ========== NAV HELPERS ========== */
      function nextStep() {
        if (idx < puzzles.length - 1) {
          idx++;
          render();
        }
      }
      function prevStep() {
        if (idx > 0) {
          idx--;
          render();
        }
      }
      function resetProgress() {
        if (
          confirm("Reset your progress? This will clear the saved position.")
        ) {
          localStorage.removeItem("hunt_idx");
          idx = 0;
          render();
        }
      }

      /* ========== EVENTS ========== */
      $("prevBtn").onclick = prevStep;
      $("nextBtn").onclick = () => {
        if (!$("nextBtn").disabled) nextStep();
      };
      $("resetBtn").onclick = resetProgress;

      // keyboard nav
      document.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft") $("prevBtn").click();
        if (e.key === "ArrowRight") {
          if (!$("nextBtn").disabled) $("nextBtn").click();
        }
      });

      // Boot
      render();
    </script>

    <!-- USAGE:
       - Replace image filenames (memory1.jpg, memory2a.jpg, jigsaw.jpg, etc.) with your images or full URLs.
       - Edit puzzles[] to change/add slides. Types: story, text, photo, jigsaw, final.
       - Text answers are case-insensitive and whitespace-normalized.
    -->
  </body>
</html>


